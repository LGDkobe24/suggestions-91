## 8 性能剖析与优化

### 建议79：了解代码优化的基本原则

代码优化是指在不改变程序运行结果的前提下使得程序运行的效率更高，优化的代码意味着运行速度更快或者占有的资源更少。进行代码优化时需要记住以下几点原则。
>
> 1. 优先保证代码是可工作的
>> Donald Knuth曾说过，过早优化是编程中一切“罪恶”的根源。很多人热衷优化，一开始写代码就奔着性能这个目标。但事实真想是“让正确的程序更快要比让快速的程序正确容易得多”。因此优化的前提是代码满足了基本的功能需求，是可工作的。
> 2. 权衡优化的代价
>> 优化是有代价的，想解决所有性能问题几乎是不可能的。
> 3. 定义性能指标，集中力量解决首要问题
> 4. 不要忽略可读性
>> 优化不能以牺牲代码的可读性，甚至带来更多的副作用为代价。

最后要说明的是：**优化无极限，不要陷入怪圈，什么时候应该优化、什么时候应该停止优化心里得有谱，性能较优的代码确实很吸引人，但过犹不及**。

### 建议80：借助性能优化工具

常见的性能优化工具右Psyco、Pypy和xPython等。

### 建议81：利用cProfile定位性能瓶颈

profile是Python的标准库。可以统计程序里每一个函数的运行实践，并且提供了多样化的报表，而cProfile则是它的C实现版本。剖析过程本身需要消耗的资源更少。所以在Python3中，cProfile代替了profile，成为默认的性能剖析模块。

pstats模块。

timeit模块。

### 建议82：使用memory_profiler和objgraph剖析内存使用

Python还提供了一些工具可以用来查看内存的使用情况以及追踪内存泄露，如memory_profiler、objgraph、cProfile、PySizer及Heapy等，或者可视化地显示对象之间的引用（如objgraph），从而为发现内存问题提供更直接的证据。

### 建议83：努力降低算法复杂度

### 掌握循环优化的基本技巧

循环的优化应遵循的原则是尽量减少循环过程中的计算量，多重循环的情形下尽量将内层的计算提到上一层。
1. 减少循环内部的计算。
2. 将显示循环改为隐式循环。
3. 在循环中尽量引用局部变量。
4. 关注内层嵌套循环。

### 建议85：使用生成器提高效率

生成器的优点总体来说有如下几条：

* 生成器提供了一种更为便利的产生迭代器的方式，用户一般不需要自己实现`__iter__`和next方法，它默认返回一个迭代器。
* 代码更为简洁、优雅。
* 充分利用了延迟评估的特性，仅在需要的时候才产生对应的元素，而不是一次生成所有的元素，从而节省了内存空间，提高了效率，理论上无限循环成为可能而不会导致MemoryError，这在大数据处理的情形下尤为重要。
* 使得协同程序更为容易实现。

### 建议86：使用不同的数据结构优化性能

### 建议87：充分利用set的优势

set在某些操作上明显比list更高效，实际上set的union、intersection、difference等操作要比list的跌打要快。

### 建议88：使用multiprocessing克服GIL的缺陷

Multiprocessing模块在使用上需要注意以下几个要点：

1. 进程之间的通信优先考虑Pipe和Queue，而不是Lock、Event、Condition、Semaphore等同步原语。
2. 尽量避免资源共享。相比于线程，进程之间资源共享的开销较大，因此要尽量避免资源共享。但如果不可避免，可以通过multiprocessing.Value和multiprocessing.Array或者multiprocessing.sharedctypes来实现内存共享，也可以通过服务器进程管理器Manager()来实现数据和状态的共享。
3. 注意平台之间的差异。由于Linux平台使用fork()函数来创建进程，因此父进程中所有的资源，如数据结构、打开的文件或者数据库的连接都会在子进程中共享，而Windows平台中父子进程相对独立，因此为了更好地保持平台的兼容性，最好能够将相关资源对象作为子进程的构造函数的参数传递进去。
4. 尽量避免使用terminate()方式终止进程，并且确保pool.map中传入的参数是可以序列化的。

### 建议89：使用线程池提高效率

线程的生命周期分为5个状态：创建、就绪、运行、阻塞和终止。自线程创建到终止，线程便不断在运行、就绪和阻塞这3个状态之间转换直至销毁。而真正占有CPU的只有运行、创建和销毁这3个状态。一个线程的运行时间由此可以分为3部分：线程的启动时间（Ts）、线程体的运行时间（Tr）以及线程的销毁时间（Td）。在多线程处理的情景中，如果线程不能够被重用，就意味这每次创建都需要经过启动、销毁和运行这3个过程。这必然会增加系统的相应时间，降低效率。而线程体的运行时间Tr不可控制，在这种情况下如何提高线程运行的效率呢？线程池便是一个解决方案。

线程池，通过将事先创建多个能够执行任务的线程放入池中，所需要执行的任务通常被安排在队列中。通常情况下，需要处理的任务比线程数目要多，线程执行完当前任务后，会从队列中取下一个任务，直到所有的任务已经完成。

由于线程预先被创建并放入线程池中，同时处理完当前任务之后并不销毁而是被安排处理下一个任务，因此能够避免多次创建线程，从而节省线程创建和销毁的开销，带来更好的性能和系统稳定性。线程池技术适合处理突发性大量请求或者需要大量线程来完成任务、但任务实际处理时间较短的应用场景，它能有效避免由于系统中创建线程过多而导致的系统性能负荷过大、响应过慢等问题。

### 建议90：使用C/C++模块扩展提高性能

### 建议91：使用Cython编写扩展模块

整个Python社区都在努力实现一个“编译器”，它可以把Python代码直接编译成等价的C/C++代码，从而获得性能提升。通过开发人员的艰苦工作，涌现出了一批这类工具，如Pyrex、Py2C和Cython等。
